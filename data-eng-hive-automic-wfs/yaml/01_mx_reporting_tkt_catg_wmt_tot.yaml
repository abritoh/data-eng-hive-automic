#==========================================================================================================================#
#==========================================================================================================================#
# FILE.......: ............................................................................................................#
# DESCRIPTION: WMT-MX TICKET-CATG Workflow.................................................................................#
# AUTHOR.....: ArBR 2021-0401..............................................................................................#
# PARAMETERS.: ............................................................................................................#
#...$hadoop_queue                  &HADOOP_QUEUE#                    intlprcincld..........................................#
#...$region_code                   &REGION_CODE#                     'MX'..................................................#
#...$company_code                  &COMPANY_CODE#                    'WMT-MX'..............................................#
#...$beg_date                      &BEG_DATE#                        '2021-01-01'..........................................#
#...$end_date                      &END_DATE#                        '2021-01-02'..........................................#
#==========================================================================================================================#
Description: "WMT-MX TICKET-CATG Workflow"
HiveQuery: "
SET hive.execution.engine=tez;
SET tez.queue.name=$hadoop_queue;
SET hive.tez.container.size=5120;
SET hive.tez.java.opts=-Xmx4096m;
SET tez.runtime.unordered.output.buffer.size-mb=512;
SET hive.auto.convert.join.noconditionaltask.size=128435456;
SET hive.exec.reducers.bytes.per.reducer=67108864;
SET hive.exec.dynamic.partition.mode=nonstrict;
SET hive.optimize.sort.dynamic.partition=true;
SET hive.exec.max.dynamic.partitions=10000;
SET hive.exec.max.dynamic.partitions.pernode=4000;
SET tez.task.timeout-ms=900000;
SET tez.grouping.min-size=32000000;
SET tez.grouping.max-size=128000000;
SET tez.grouping.split-waves=10.0;
SET mapreduce.input.fileinputformat.split.maxsize=67108864;
SET hive.exec.parallel=true;
SET hive.vectorized.execution.enabled=true;
SET hive.vectorized.execution.reduce.enabled=true;
SET hive.vectorized.execution.reduce.groupby.enabled=true;
SET hive.merge.tezfiles=true;
SET hive.merge.smallfiles.avgsize=128000000;
SET hive.merge.size.per.task=128000000;

CREATE TABLE IF NOT EXISTS $target_schema.$target_table_catg
(    
	BANNER_CD					CHAR(2)
    , BANNER_DESC				VARCHAR(20)
    , TRIBE_NBR					INT
    , TRIBE_DESC				VARCHAR(50)
    , SQUAD_NBR					INT
    , SQUAD_DESC				VARCHAR(50)
    , CAT_NBR					SMALLINT
    , CAT_DESC					VARCHAR(50)

	, CUST_LY_TOT_UNIT_QTY		INT
	, CUST_CY_TOT_UNIT_QTY		INT
	, CUST_LY_EQ_UNIT_QTY		INT
	, CUST_CY_EQ_UNIT_QTY		INT
	, TKT_SALE_LY_TOT_UNIT_AMT	DECIMAL(19,2)
	, TKT_SALE_CY_TOT_UNIT_AMT	DECIMAL(19,2)
	, TKT_SALE_LY_EQ_UNIT_AMT	DECIMAL(19,2)
	, TKT_SALE_CY_EQ_UNIT_AMT	DECIMAL(19,2)
	, TKT_LY_TOT_UNIT_QTY		INT
	, TKT_CY_TOT_UNIT_QTY		INT
	, TKT_LY_EQ_UNIT_QTY		INT
	, TKT_CY_EQ_UNIT_QTY		INT

    , VISIT_LY_DT				DATE
)
PARTITIONED BY ( VISIT_CY_DT DATE )
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\u0001'
STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY', 'auto.purge'='true')
;

DROP TABLE IF EXISTS $stg_schema.$stg_table_tot_ly;
CREATE TABLE IF NOT EXISTS $stg_schema.$stg_table_tot_ly
(    
	BANNER_CD				CHAR(2)
    , BANNER_DESC			VARCHAR(20)
    , TRIBE_NBR				INT
    , TRIBE_DESC			VARCHAR(50)
    , SQUAD_NBR				INT
    , SQUAD_DESC			VARCHAR(50)
    , CAT_NBR				SMALLINT
    , CAT_DESC				VARCHAR(50)

	, CUST_TOT_UNIT_QTY		INT
	, CUST_EQ_UNIT_QTY		INT
	, TKT_SALE_TOT_UNIT_AMT	DECIMAL(19,2)
	, TKT_SALE_EQ_UNIT_AMT	DECIMAL(19,2)
	, TKT_TOT_UNIT_QTY		INT
	, TKT_EQ_UNIT_QTY		INT

    , VISIT_LY_DT			DATE
)
PARTITIONED BY ( VISIT_CY_DT DATE )
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\u0001'
STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY', 'auto.purge'='true')
;

DROP TABLE IF EXISTS $stg_schema.$stg_table_tot_cy;
CREATE TABLE IF NOT EXISTS $stg_schema.$stg_table_tot_cy
(    
	BANNER_CD				CHAR(2)
    , BANNER_DESC			VARCHAR(20)
    , TRIBE_NBR				INT
    , TRIBE_DESC			VARCHAR(50)
    , SQUAD_NBR				INT
    , SQUAD_DESC			VARCHAR(50)
    , CAT_NBR				SMALLINT
    , CAT_DESC				VARCHAR(50)

	, CUST_TOT_UNIT_QTY		INT
	, CUST_EQ_UNIT_QTY		INT
	, TKT_SALE_TOT_UNIT_AMT	DECIMAL(19,2)
	, TKT_SALE_EQ_UNIT_AMT	DECIMAL(19,2)
	, TKT_TOT_UNIT_QTY		INT
	, TKT_EQ_UNIT_QTY		INT

    , VISIT_LY_DT			DATE
)
PARTITIONED BY ( VISIT_CY_DT DATE )
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\u0001'
STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY', 'auto.purge'='true')
;

INSERT OVERWRITE TABLE $stg_schema.$stg_table_tot_ly
PARTITION (VISIT_CY_DT)
SELECT 
	 COALESCE(SCAN.BANNER_CD, 'XX') AS BANNER_CD
	, COALESCE(SCAN.BANNER_DESC, 'XXXX') AS BANNER_DESC
	, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999) AS TRIBE_NBR
	, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX') AS TRIBE_DESC
	, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) AS SQUAD_NBR
	, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') AS SQUAD_DESC
    , COALESCE(TRIBU.DN_CATEGORY_NBR, -999) AS CAT_NBR
	, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') AS CAT_DESC	

	, COUNT(DISTINCT CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR)) AS CUST_TOT_UNIT_QTY
	, COUNT(DISTINCT CASE WHEN SCAN.STORE_COMP_IND = 1 THEN  CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR) END) CUST_EQ_UNIT_QTY
	, SUM(0) AS TKT_SALE_TOT_UNIT_AMT
	, SUM(0) AS TKT_SALE_EQ_UNIT_AMT
	, SUM(0) AS TKT_TOT_UNIT_QTY
	, SUM(0) AS TKT_EQ_UNIT_QTY

	, VISIT_DT AS VISIT_LY_DT
	, add_months(VISIT_DT, 12) AS VISIT_CY_DT
	FROM $src_schema_mx_spot_run.$src_table_visit_scan_wmt AS SCAN
		LEFT JOIN $src_schema_mx_core_dim.$src_table_item_dim AS IT ON SCAN.SCAN_ID = IT.MDS_FAM_ID AND SCAN.OP_CMPNY_CD = IT.OP_CMPNY_CD AND IT.CURR_IND = 1 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_tribu TRIBU ON TRIBU.DN_DEPT_NBR = IT.DEPT_NBR AND TRIBU.DN_CATEGORY_NBR  = SUBSTR(IT.FINELINE_NBR, 1,2) AND TRIBU.DX_STATUS_CODE = 'A' 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_dept_cat DEPT ON DEPT.KN_DEPT_NBR = TRIBU.DN_DEPT_NBR  AND DEPT.DN_CATEGORY_NBR = TRIBU.DN_CATEGORY_NBR AND DEPT.DX_STATUS=1 
    WHERE SCAN.GEO_REGION_CD = $region_code AND SCAN.OP_CMPNY_CD = $company_code 
		AND SCAN.DEPT_NBR NOT IN (49,50,72,75,99) 
		AND SCAN.VISIT_DT BETWEEN add_months(TO_DATE($beg_date), -12) AND add_months(TO_DATE($end_date), -12)
    GROUP BY 
		COALESCE(SCAN.BANNER_CD, 'XX') 
		, COALESCE(SCAN.BANNER_DESC, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') 
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') 
		, SCAN.VISIT_DT 
UNION
	SELECT 
		COALESCE(SCAN.BANNER_CD, 'XX') AS BANNER_CD
		, COALESCE(SCAN.BANNER_DESC, 'XXXX') AS BANNER_DESC
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999) AS TRIBE_NBR
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX') AS TRIBE_DESC
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) AS SQUAD_NBR
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') AS SQUAD_DESC
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) AS CAT_NBR
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') AS CAT_DESC					

		, SUM(0) AS CUST_TOT_UNIT_QTY
		, SUM(0) AS CUST_EQ_UNIT_QTY
		, SUM(SCAN.SCAN_RTL_AMT) TKT_SALE_TOT_UNIT_AMT
		, SUM(CASE WHEN SCAN.STORE_COMP_IND = 1 THEN SCAN.SCAN_RTL_AMT ELSE 0 END) TKT_SALE_EQ_UNIT_AMT
		, SUM(0) AS TKT_TOT_UNIT_QTY
		, SUM(0) AS TKT_EQ_UNIT_QTY

		, VISIT_DT AS VISIT_LY_DT
		, add_months(VISIT_DT, 12) AS VISIT_CY_DT
    FROM $src_schema_mx_spot_run.$src_table_visit_scan_wmt AS SCAN
		LEFT JOIN $src_schema_mx_core_dim.$src_table_item_dim AS IT ON SCAN.SCAN_ID = IT.MDS_FAM_ID AND SCAN.OP_CMPNY_CD = IT.OP_CMPNY_CD AND IT.CURR_IND = 1 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_tribu TRIBU ON TRIBU.DN_DEPT_NBR = IT.DEPT_NBR AND TRIBU.DN_CATEGORY_NBR  = SUBSTR(IT.FINELINE_NBR, 1,2) AND TRIBU.DX_STATUS_CODE = 'A' 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_dept_cat DEPT ON DEPT.KN_DEPT_NBR = TRIBU.DN_DEPT_NBR  AND DEPT.DN_CATEGORY_NBR = TRIBU.DN_CATEGORY_NBR AND DEPT.DX_STATUS=1 
		WHERE SCAN.GEO_REGION_CD = $region_code AND SCAN.OP_CMPNY_CD = $company_code 
		AND SCAN.DEPT_NBR NOT IN (49,50,72,75,99) 
		AND SCAN.VISIT_DT BETWEEN add_months(TO_DATE($beg_date), -12) AND add_months(TO_DATE($end_date), -12)
    GROUP BY 
		COALESCE(SCAN.BANNER_CD, 'XX') 
		, COALESCE(SCAN.BANNER_DESC, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') 
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') 
		, SCAN.VISIT_DT 
UNION
	SELECT 
		COALESCE(SCAN.BANNER_CD, 'XX') AS BANNER_CD
		, COALESCE(SCAN.BANNER_DESC, 'XXXX') AS BANNER_DESC
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999) AS TRIBE_NBR
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX') AS TRIBE_DESC
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) AS SQUAD_NBR
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') AS SQUAD_DESC
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) AS CAT_NBR
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') AS CAT_DESC
		
		, SUM(0) AS CUST_TOT_UNIT_QTY
		, SUM(0) AS CUST_EQ_UNIT_QTY
		, SUM(0) AS TKT_SALE_TOT_UNIT_AMT
		, SUM(0) AS TKT_SALE_EQ_UNIT_AMT
		, COUNT(DISTINCT CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR)) AS TKT_TOT_UNIT_QTY
		, COUNT(DISTINCT CASE WHEN SCAN.STORE_COMP_IND = 1 THEN  CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR) END) TKT_EQ_UNIT_QTY
		
		, VISIT_DT AS VISIT_LY_DT
		, add_months(VISIT_DT, 12) AS VISIT_CY_DT
	FROM $src_schema_mx_spot_run.$src_table_visit_scan_wmt AS SCAN
		LEFT JOIN $src_schema_mx_core_dim.$src_table_item_dim AS IT ON SCAN.SCAN_ID = IT.MDS_FAM_ID AND SCAN.OP_CMPNY_CD = IT.OP_CMPNY_CD AND IT.CURR_IND = 1 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_tribu TRIBU ON TRIBU.DN_DEPT_NBR = IT.DEPT_NBR AND TRIBU.DN_CATEGORY_NBR  = SUBSTR(IT.FINELINE_NBR, 1,2) AND TRIBU.DX_STATUS_CODE = 'A' 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_dept_cat DEPT ON DEPT.KN_DEPT_NBR = TRIBU.DN_DEPT_NBR  AND DEPT.DN_CATEGORY_NBR = TRIBU.DN_CATEGORY_NBR AND DEPT.DX_STATUS=1 
	WHERE SCAN.GEO_REGION_CD = $region_code AND SCAN.OP_CMPNY_CD = $company_code 
		AND SCAN.DEPT_NBR NOT IN (49,50,72,75,99) 
		AND SCAN.VISIT_DT BETWEEN add_months(TO_DATE($beg_date), -12) AND add_months(TO_DATE($end_date), -12)
	GROUP BY 
		COALESCE(SCAN.BANNER_CD, 'XX') 
		, COALESCE(SCAN.BANNER_DESC, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') 
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') 
		, SCAN.VISIT_DT 
;         

INSERT OVERWRITE TABLE $stg_schema.$stg_table_tot_cy
PARTITION (VISIT_CY_DT)
SELECT 
	 COALESCE(SCAN.BANNER_CD, 'XX') AS BANNER_CD
	, COALESCE(SCAN.BANNER_DESC, 'XXXX') AS BANNER_DESC
	, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999) AS TRIBE_NBR
	, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX') AS TRIBE_DESC
	, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) AS SQUAD_NBR
	, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') AS SQUAD_DESC
    , COALESCE(TRIBU.DN_CATEGORY_NBR, -999) AS CAT_NBR
	, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') AS CAT_DESC	

	, COUNT(DISTINCT CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR)) AS CUST_TOT_UNIT_QTY
	, COUNT(DISTINCT CASE WHEN SCAN.STORE_COMP_IND = 1 THEN  CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR) END) CUST_EQ_UNIT_QTY

	, SUM(0) AS TKT_SALE_TOT_UNIT_AMT
	, SUM(0) AS TKT_SALE_EQ_UNIT_AMT
	, SUM(0) AS TKT_TOT_UNIT_QTY
	, SUM(0) AS TKT_EQ_UNIT_QTY

	, add_months(VISIT_DT, -12) AS VISIT_LY_DT
	, VISIT_DT AS VISIT_CY_DT
	FROM $src_schema_mx_spot_run.$src_table_visit_scan_wmt AS SCAN
		LEFT JOIN $src_schema_mx_core_dim.$src_table_item_dim AS IT ON SCAN.SCAN_ID = IT.MDS_FAM_ID AND SCAN.OP_CMPNY_CD = IT.OP_CMPNY_CD AND IT.CURR_IND = 1 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_tribu TRIBU ON TRIBU.DN_DEPT_NBR = IT.DEPT_NBR AND TRIBU.DN_CATEGORY_NBR  = SUBSTR(IT.FINELINE_NBR, 1,2) AND TRIBU.DX_STATUS_CODE = 'A' 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_dept_cat DEPT ON DEPT.KN_DEPT_NBR = TRIBU.DN_DEPT_NBR  AND DEPT.DN_CATEGORY_NBR = TRIBU.DN_CATEGORY_NBR AND DEPT.DX_STATUS=1 
    WHERE SCAN.GEO_REGION_CD = $region_code AND SCAN.OP_CMPNY_CD = $company_code 
		AND SCAN.DEPT_NBR NOT IN (49,50,72,75,99) 
		AND SCAN.VISIT_DT BETWEEN $beg_date AND $end_date
    GROUP BY 
		COALESCE(SCAN.BANNER_CD, 'XX') 
		, COALESCE(SCAN.BANNER_DESC, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') 
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') 
		, SCAN.VISIT_DT 
UNION
	SELECT 
		COALESCE(SCAN.BANNER_CD, 'XX') AS BANNER_CD
		, COALESCE(SCAN.BANNER_DESC, 'XXXX') AS BANNER_DESC
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999) AS TRIBE_NBR
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX') AS TRIBE_DESC
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) AS SQUAD_NBR
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') AS SQUAD_DESC
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) AS CAT_NBR
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') AS CAT_DESC					

		, SUM(0) AS CUST_TOT_UNIT_QTY
		, SUM(0) AS CUST_EQ_UNIT_QTY
		, SUM(SCAN.SCAN_RTL_AMT) TKT_SALE_TOT_UNIT_AMT
		, SUM(CASE WHEN SCAN.STORE_COMP_IND = 1 THEN SCAN.SCAN_RTL_AMT ELSE 0 END) TKT_SALE_EQ_UNIT_AMT
		, SUM(0) AS TKT_TOT_UNIT_QTY
		, SUM(0) AS TKT_EQ_UNIT_QTY

		, add_months(VISIT_DT, -12) AS VISIT_LY_DT
		, VISIT_DT AS VISIT_CY_DT
    FROM $src_schema_mx_spot_run.$src_table_visit_scan_wmt AS SCAN
		LEFT JOIN $src_schema_mx_core_dim.$src_table_item_dim AS IT ON SCAN.SCAN_ID = IT.MDS_FAM_ID AND SCAN.OP_CMPNY_CD = IT.OP_CMPNY_CD AND IT.CURR_IND = 1 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_tribu TRIBU ON TRIBU.DN_DEPT_NBR = IT.DEPT_NBR AND TRIBU.DN_CATEGORY_NBR  = SUBSTR(IT.FINELINE_NBR, 1,2) AND TRIBU.DX_STATUS_CODE = 'A' 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_dept_cat DEPT ON DEPT.KN_DEPT_NBR = TRIBU.DN_DEPT_NBR  AND DEPT.DN_CATEGORY_NBR = TRIBU.DN_CATEGORY_NBR AND DEPT.DX_STATUS=1 
		WHERE SCAN.GEO_REGION_CD = $region_code AND SCAN.OP_CMPNY_CD = $company_code 
		AND SCAN.DEPT_NBR NOT IN (49,50,72,75,99) 
		AND SCAN.VISIT_DT BETWEEN $beg_date AND $end_date
    GROUP BY 
		COALESCE(SCAN.BANNER_CD, 'XX') 
		, COALESCE(SCAN.BANNER_DESC, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') 
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') 
		, SCAN.VISIT_DT 
UNION
	SELECT 
		COALESCE(SCAN.BANNER_CD, 'XX') AS BANNER_CD
		, COALESCE(SCAN.BANNER_DESC, 'XXXX') AS BANNER_DESC
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999) AS TRIBE_NBR
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX') AS TRIBE_DESC
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) AS SQUAD_NBR
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') AS SQUAD_DESC
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) AS CAT_NBR
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') AS CAT_DESC
		
		, SUM(0) AS CUST_TOT_UNIT_QTY
		, SUM(0) AS CUST_EQ_UNIT_QTY
		, SUM(0) AS TKT_SALE_TOT_UNIT_AMT
		, SUM(0) AS TKT_SALE_EQ_UNIT_AMT
		, COUNT(DISTINCT CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR)) AS TKT_TOT_UNIT_QTY
		, COUNT(DISTINCT CASE WHEN SCAN.STORE_COMP_IND = 1 THEN  CONCAT(SCAN.STORE_NBR, SCAN.VISIT_NBR) END) TKT_EQ_UNIT_QTY
		
		, add_months(VISIT_DT, -12) AS VISIT_LY_DT
		, VISIT_DT AS VISIT_CY_DT
	FROM $src_schema_mx_spot_run.$src_table_visit_scan_wmt AS SCAN
		LEFT JOIN $src_schema_mx_core_dim.$src_table_item_dim AS IT ON SCAN.SCAN_ID = IT.MDS_FAM_ID AND SCAN.OP_CMPNY_CD = IT.OP_CMPNY_CD AND IT.CURR_IND = 1 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_tribu TRIBU ON TRIBU.DN_DEPT_NBR = IT.DEPT_NBR AND TRIBU.DN_CATEGORY_NBR  = SUBSTR(IT.FINELINE_NBR, 1,2) AND TRIBU.DX_STATUS_CODE = 'A' 
		LEFT JOIN $src_schema_mx_ecomm.$src_table_dimensions_dept_cat DEPT ON DEPT.KN_DEPT_NBR = TRIBU.DN_DEPT_NBR  AND DEPT.DN_CATEGORY_NBR = TRIBU.DN_CATEGORY_NBR AND DEPT.DX_STATUS=1 
	WHERE SCAN.GEO_REGION_CD = $region_code AND SCAN.OP_CMPNY_CD = $company_code 
		AND SCAN.DEPT_NBR NOT IN (49,50,72,75,99) 
		AND SCAN.VISIT_DT BETWEEN $beg_date AND $end_date
	GROUP BY 
		COALESCE(SCAN.BANNER_CD, 'XX') 
		, COALESCE(SCAN.BANNER_DESC, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_TRIBU_NBR, -999)
		, COALESCE(TRIBU.DX_CXC_TRIBU_NAME, 'XXXX')
		, COALESCE(TRIBU.SK_CXC_SQUAD_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_SQUAD_NAME, 'XXXX') 
		, COALESCE(TRIBU.DN_CATEGORY_NBR, -999) 
		, COALESCE(TRIBU.DX_CXC_CATEGORY_NAME, 'XXXX') 
		, SCAN.VISIT_DT 
;  


INSERT OVERWRITE TABLE $target_schema.$target_table_catg
PARTITION (VISIT_CY_DT)
SELECT 
	 BANNER_CD
	, BANNER_DESC
    , TRIBE_NBR
    , TRIBE_DESC
    , SQUAD_NBR
    , SQUAD_DESC
    , CAT_NBR
    , CAT_DESC

	, SUM(CUST_LY_TOT_UNIT_QTY) AS CUST_LY_TOT_UNIT_QTY
	, SUM(CUST_CY_TOT_UNIT_QTY) AS CUST_CY_TOT_UNIT_QTY
	, SUM(CUST_LY_EQ_UNIT_QTY) AS CUST_LY_EQ_UNIT_QTY
	, SUM(CUST_CY_EQ_UNIT_QTY) AS CUST_CY_EQ_UNIT_QTY
	, SUM(TKT_SALE_LY_TOT_UNIT_AMT) AS TKT_SALE_LY_TOT_UNIT_AMT
	, SUM(TKT_SALE_CY_TOT_UNIT_AMT) AS TKT_SALE_CY_TOT_UNIT_AMT
	, SUM(TKT_SALE_LY_EQ_UNIT_AMT) AS TKT_SALE_LY_EQ_UNIT_AMT
	, SUM(TKT_SALE_CY_EQ_UNIT_AMT) AS TKT_SALE_CY_EQ_UNIT_AMT
	, SUM(TKT_LY_TOT_UNIT_QTY) AS TKT_LY_TOT_UNIT_QTY
	, SUM(TKT_CY_TOT_UNIT_QTY) AS TKT_CY_TOT_UNIT_QTY
	, SUM(TKT_LY_EQ_UNIT_QTY) AS TKT_LY_EQ_UNIT_QTY
	, SUM(TKT_CY_EQ_UNIT_QTY) AS TKT_CY_EQ_UNIT_QTY

    , VISIT_LY_DT
	, VISIT_CY_DT
FROM 
(
	SELECT 
		BANNER_CD
		, BANNER_DESC
		, TRIBE_NBR
		, TRIBE_DESC
		, SQUAD_NBR
		, SQUAD_DESC
		, CAT_NBR
		, CAT_DESC

		, CUST_TOT_UNIT_QTY AS CUST_LY_TOT_UNIT_QTY
		, 0 AS CUST_CY_TOT_UNIT_QTY
		, CUST_EQ_UNIT_QTY AS CUST_LY_EQ_UNIT_QTY
		, 0 AS CUST_CY_EQ_UNIT_QTY
		, TKT_SALE_TOT_UNIT_AMT AS TKT_SALE_LY_TOT_UNIT_AMT
		, 0 AS TKT_SALE_CY_TOT_UNIT_AMT
		, TKT_SALE_EQ_UNIT_AMT AS TKT_SALE_LY_EQ_UNIT_AMT
		, 0 AS TKT_SALE_CY_EQ_UNIT_AMT
		, TKT_TOT_UNIT_QTY AS TKT_LY_TOT_UNIT_QTY
		, 0 AS TKT_CY_TOT_UNIT_QTY
		, TKT_EQ_UNIT_QTY AS TKT_LY_EQ_UNIT_QTY
		, 0 AS TKT_CY_EQ_UNIT_QTY

		, VISIT_LY_DT
		, VISIT_CY_DT
	FROM $stg_schema.$stg_table_tot_ly

	UNION ALL

	SELECT 
		BANNER_CD
		, BANNER_DESC
		, TRIBE_NBR
		, TRIBE_DESC
		, SQUAD_NBR
		, SQUAD_DESC
		, CAT_NBR
		, CAT_DESC

		, 0 AS CUST_LY_TOT_UNIT_QTY
		, CUST_TOT_UNIT_QTY AS CUST_CY_TOT_UNIT_QTY
		, 0 AS CUST_LY_EQ_UNIT_QTY
		, CUST_EQ_UNIT_QTY AS CUST_CY_EQ_UNIT_QTY
		, 0 AS TKT_SALE_LY_TOT_UNIT_AMT
		, TKT_SALE_TOT_UNIT_AMT AS TKT_SALE_CY_TOT_UNIT_AMT
		, 0 AS TKT_SALE_LY_EQ_UNIT_AMT
		, TKT_SALE_EQ_UNIT_AMT AS TKT_SALE_CY_EQ_UNIT_AMT
		, 0 AS TKT_LY_TOT_UNIT_QTY
		, TKT_TOT_UNIT_QTY AS TKT_CY_TOT_UNIT_QTY
		, 0 AS TKT_LY_EQ_UNIT_QTY
		, TKT_EQ_UNIT_QTY AS TKT_CY_EQ_UNIT_QTY

		, VISIT_LY_DT
		, VISIT_CY_DT
	FROM $stg_schema.$stg_table_tot_cy

) X
GROUP BY 
	BANNER_CD
	, BANNER_DESC
    , TRIBE_NBR
    , TRIBE_DESC
    , SQUAD_NBR
    , SQUAD_DESC
	, CAT_NBR
	, CAT_DESC
    , VISIT_LY_DT
	, VISIT_CY_DT
;

dfs -chgrp -R $group_name /user/hive/.../$target_schema.db/$target_table_catg; 
dfs -chmod -R $permission /user/hive/.../$target_schema.db/$target_table_catg;
"